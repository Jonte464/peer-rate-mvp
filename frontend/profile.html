<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Min profil ‚Äì PeerRate</title>

  <link rel="stylesheet" href="/css/pr-theme.css" />
  <link rel="stylesheet" href="/css/profile.css" />
</head>

<body>

  <!-- TOP ROW (samma struktur/ID som index f√∂r att main.js ska fungera) -->
  <header class="top-row">
    <div class="shell top-row-inner">
      <a class="brand soft-hover" href="/#top">
        <div class="logo-badge" aria-hidden="true">
          <img class="logo-img" src="/assets/Logo.PNG?v=1" alt="PeerRate logo" />
        </div>
        <div>
          <div class="brand-name">PeerRate</div>
          <div class="brand-sub" data-i18n="top_sub">F√∂rtroende du kan bevisa</div>
        </div>
      </a>

      <div class="top-actions">
        <div class="top-user" id="topUserPill" aria-live="polite" title="Inloggad" aria-expanded="false">
          <span id="topUserInitials">?</span>
        </div>

        <div class="user-menu" id="userMenu" role="menu" aria-label="Anv√§ndarmeny">
          <button type="button" id="logoutBtn" data-i18n="user_logout">Logga ut</button>
        </div>

        <button class="lang-pill soft-hover" id="langBtn" type="button" aria-haspopup="true" aria-expanded="false">
          <span id="langLabel">SV</span>
          <span style="opacity:.6;">‚ñæ</span>
        </button>

        <button class="menu-btn soft-hover" id="menuBtn" type="button" aria-label="√ñppna meny" aria-expanded="false">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="rgba(15,15,18,.85)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="lang-menu" id="langMenu" role="menu" aria-label="V√§lj spr√•k">
      <button type="button" data-lang="sv">Svenska (SV)</button>
      <button type="button" data-lang="en">English (EN)</button>
    </div>

    <nav class="menu-panel" id="menuPanel" aria-label="Meny">
      <div class="shell menu-panel-inner">
        <a class="menu-link" href="/#how"><div data-i18n="menu_how">Hur det funkar</div><span>‚Üí</span></a>
        <a class="menu-link" href="/#sim"><div data-i18n="menu_sim">Se v√§rdet direkt</div><span>‚Üí</span></a>
        <!-- Global trust and "L√§mna betyg" removed from menu -->
        <a class="menu-link" href="/customer.html"><div data-i18n="menu_signup">Registrera dig</div><span>‚Üí</span></a>
        <a class="menu-link" href="/profile.html"><div data-i18n="menu_profile">Min profil</div><span>‚Üí</span></a>
        <a class="menu-link" href="/my-details.html"><div>My details</div><span>‚Üí</span></a>
      </div>
    </nav>
  </header>

  <main class="page">
    <div class="wrap">

      <!-- Inloggningsbadge -->
      <div id="user-badge" class="user-badge hidden">
        <div class="user-avatar" id="user-badge-avatar">PR</div>
        <div>
          <div class="user-label" data-i18n="profile_badge_label">Inloggad som</div>
          <div class="user-name" id="user-badge-name">‚Äì</div>
        </div>
      </div>

      <!-- (Invite compact removed) ‚Äî larger invite form placed beside profile card below -->
      <style>
        /* Ensure profile page text is white for readability on darkened video background */
        .page, .page * { color: #ffffff !important; }

        /* Make the embedded engagement feedback form readable (dark text on light inputs)
           The page globally forces white text, so target only the feedback form area to
           avoid changing other profile cards. */
        #engagement-feedback-form, #engagement-feedback-form * { color: #0b1720 !important; }
        #engagement-feedback-form input, #engagement-feedback-form textarea, #engagement-feedback-form select {
          background: #ffffff !important;
          color: #0b1720 !important;
          border: 1px solid #e5e7eb !important;
        }
        #engagement-feedback-form input::placeholder, #engagement-feedback-form textarea::placeholder { color: rgba(15,15,18,0.45) !important; }
        #engagement-feedback-form .tiny.muted { color: rgba(15,15,18,0.6) !important; }

        /* Keep profile and invite side-by-side on desktop, allow wrap on small screens */
        .top-profile-row { flex-wrap: nowrap; }
        @media (max-width: 980px) {
          .top-profile-row { flex-wrap: wrap !important; }
          .trust-profile-card { min-width: 320px !important; flex: 1 1 100% !important; }
          .top-profile-row aside.card { max-width: 100% !important; flex: 1 1 100% !important; }
        }
        /* Frosted, translucent cards and profile-specific input styles */
        #profile-root .card,
        .top-profile-row .trust-profile-card,
        .top-profile-row aside.card {
          background: rgba(255,255,255,0.06) !important;
          border: 1px solid rgba(255,255,255,0.09) !important;
          color: #ffffff !important;
          -webkit-backdrop-filter: blur(8px) saturate(120%);
          backdrop-filter: blur(8px) saturate(120%);
          box-shadow: 0 6px 20px rgba(2,6,23,0.35) !important;
        }
        /* Make text and muted text lighter for readability */
        #profile-root .muted, #profile-root .tiny { color: rgba(255,255,255,0.75) !important; }
        #profile-root h1, #profile-root h2, #profile-root h3 { color: #fff !important; }
        /* Inputs on profile page should be translucent */
        #profile-root input, #profile-root textarea, #profile-root select {
          background: rgba(255,255,255,0.04) !important;
          border: 1px solid rgba(255,255,255,0.12) !important;
          color: #fff !important;
        }
        #profile-root input::placeholder, #profile-root textarea::placeholder { color: rgba(255,255,255,0.6) !important; }
        /* Buttons: keep current accent but ensure readable on translucent cards */
        #profile-root .primary { color: #fff !important; }

        /* Override specific inline white sub-cards inside `.trust-profile-card` so they become frosted */
        .trust-profile-card div[style*="background:#f8fafc"],
        .trust-profile-card div[style*="background:#fbfbff"],
        .trust-profile-card div[style*="background:#f1f5f9"],
        .trust-profile-card div[style*="background:#ffffff"],
        .trust-profile-card section[style*="background:#fbfbff"] {
          background: rgba(255,255,255,0.04) !important;
          border: 1px solid rgba(255,255,255,0.08) !important;
          color: #fff !important;
          box-shadow: none !important;
        }
        /* Keep small colored badges intact (spans) by not overriding span backgrounds */
        .trust-profile-card span[style*="background:"] { color: inherit !important; }
      </style>
      <!-- Full-bleed background video (reuses landing hero video) -->
      <div id="profile-bg-video" aria-hidden="true" style="position:fixed;inset:0;overflow:hidden;z-index:-2;pointer-events:none;">
        <video autoplay muted loop playsinline preload="auto" style="width:100%;height:100%;object-fit:cover;transform:translateZ(0);">
          <source src="/assets/hero.mp4?v=4" type="video/mp4" />
        </video>
        <div style="position:absolute;inset:0;background:linear-gradient(180deg,rgba(10,12,20,0.25),rgba(5,8,15,0.5));mix-blend-mode:multiply;pointer-events:none;"></div>
      </div>
      

      <h1 data-i18n="profile_h1">Min profil</h1>
      <p class="lead" data-i18n="profile_lead">
        H√§r kan du se dina uppgifter och ditt samlade omd√∂me.
      </p>

      <!-- LOGIN-KORT (visas bara om man inte √§r inloggad) -->
      <section class="card" id="login-card">
        <h2 data-i18n="profile_login_title">Logga in</h2>
        <p class="muted" data-i18n="profile_login_lead">
          Logga in med den e-post och det l√∂senord du registrerade dig med.
        </p>

        <form id="login-form" autocomplete="off">
          <label for="login-email" data-i18n="profile_login_email">E-post</label>
          <input id="login-email" name="email" type="email" placeholder="erik@example.com" />

          <label for="login-password" data-i18n="profile_login_password">L√∂senord</label>
          <input id="login-password" name="password" type="password" placeholder="Ditt l√∂senord" />

          <div class="row" style="margin-top:12px">
            <button class="primary" type="submit" id="login-btn" data-i18n="profile_login_btn">Logga in</button>
          </div>

          <p id="login-status" class="tiny muted" style="margin-top:8px;"></p>
        </form>
      </section>

      <!-- Allt h√§r visas bara n√§r man √§r inloggad -->
      <div id="profile-root" class="hidden">

        <!-- Trust Profile Card (matches design) and Invite form side-by-side) -->
        <div class="top-profile-row" style="display:flex;gap:24px;align-items:flex-start;max-width:1440px;margin-left:auto;margin-right:auto;margin-bottom:32px;flex-wrap:nowrap;">
          <section class="trust-profile-card" style="background:#ffffff;border-radius:12px;padding:12px;border:1px solid rgba(11,22,51,0.06);box-shadow:0 8px 24px rgba(11,22,51,0.06);margin-top:0;max-width:100%;">
          <div style="display:flex;align-items:center;gap:12px;">
          <img id="profile-photo" src="https://randomuser.me/api/portraits/women/44.jpg" alt="Profile photo" style="width:56px;height:56px;border-radius:50%;object-fit:cover;border:1px solid rgba(11,22,51,0.06);box-shadow:0 1px 2px rgba(11,22,51,0.04);">
          <div style="flex:1;min-width:0;">
            <div id="profile-fullname" style="font-size:1rem;font-weight:700;line-height:1;color:rgba(11,22,51,0.95);">Anna Larsson</div>
            <div id="profile-title" style="font-size:0.82rem;color:rgba(11,22,51,0.7);margin-top:2px;">Senior Project Manager</div>
            <div id="profile-location" style="font-size:0.78rem;color:rgba(11,22,51,0.6);margin-top:1px;">Stockholm, Sweden</div>
          </div>
          <div style="flex-shrink:0;">
            <button id="profile-share-btn" style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.18);color:#0369a1;padding:6px 10px;border-radius:8px;font-size:12px;font-weight:700;">Share</button>
          </div>
        </div>

          <div style="margin-top:12px;background:#ffffff;border-radius:8px;padding:12px;border:1px solid rgba(11,22,51,0.03);">
          <div style="font-weight:700;font-size:0.9rem;color:rgba(11,22,51,0.95);margin-bottom:6px;">PeerRate Score: <span id="profile-score-big" style="font-size:1.4rem;font-weight:800;color:#1d4ed8;margin-left:6px;">82</span><span style="font-size:0.78rem;color:rgba(11,22,51,0.6);margin-left:6px;"> of 100</span></div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;" id="profile-tags">
            <span id="badge-verified" style="background:rgba(59,130,246,0.08);color:#0369a1;padding:6px 10px;border-radius:8px;font-weight:700;font-size:12px;">Verified</span>
            <span id="badge-confidence" style="background:rgba(59,130,246,0.08);color:#0369a1;padding:6px 10px;border-radius:8px;font-weight:700;font-size:12px;">High</span>
            <span id="badge-strong" style="background:rgba(59,130,246,0.08);color:#0369a1;padding:6px 10px;border-radius:8px;font-weight:700;font-size:12px;">Strong</span>
          </div>

          <div style="display:flex;gap:10px;margin-top:8px;align-items:center;">
            <div style="flex:1;min-width:0;display:flex;align-items:center;gap:6px;color:rgba(11,22,51,0.85);">
              <div style="font-size:1rem;color:#16a34a;">‚úîÔ∏è</div>
              <div style="font-weight:700;font-size:0.92rem;">Client Feedback: <span style="font-weight:600;margin-left:6px;color:rgba(11,22,51,0.8);font-size:0.9rem;" id="feedback-client">Excellent</span></div>
            </div>
            <div style="flex:1;min-width:0;display:flex;align-items:center;gap:6px;color:rgba(11,22,51,0.85);">
              <div style="font-size:1rem;color:#16a34a;">‚úîÔ∏è</div>
              <div style="font-weight:700;font-size:0.92rem;">Leadership & Collaboration: <span style="font-weight:600;margin-left:6px;color:rgba(11,22,51,0.8);font-size:0.9rem;" id="feedback-leadership">Strong</span></div>
            </div>
            <div style="flex:1;min-width:0;display:flex;align-items:center;gap:6px;color:rgba(11,22,51,0.85);">
              <div style="font-size:1rem;color:#16a34a;">‚úîÔ∏è</div>
              <div style="font-weight:700;font-size:0.92rem;">Consistency: <span style="font-weight:600;margin-left:6px;color:rgba(11,22,51,0.8);font-size:0.9rem;" id="feedback-consistency">Recent & Stable</span></div>
            </div>
          </div>

          <div style="margin-top:8px;display:flex;align-items:center;gap:6px;color:rgba(11,22,51,0.85);">
            <div style="font-size:1rem;color:#1d4ed8;">‚úîÔ∏è</div>
            <div><span style="font-weight:700;font-size:0.92rem;">Verification Level:</span> <span style="margin-left:6px;color:rgba(11,22,51,0.8);font-size:0.9rem;" id="verification-level">High</span></div>
          </div>
        </div>

        <div style="margin-top:18px;">
          <div style="font-size:1rem;font-weight:700;color:rgba(11,22,51,0.95);margin-bottom:8px;">Recent Engagement</div>
          <div id="recent-engagement-card" style="background:#fbfbff;border:1px solid rgba(11,22,51,0.03);border-radius:10px;padding:14px;display:flex;align-items:flex-start;gap:14px;transition:opacity .35s ease;">
            <div style="font-size:1.6rem;color:#3b82f6;">üè¶</div>
            <div style="flex:1;color:rgba(11,22,51,0.9);">
              <div style="font-size:0.9rem;font-weight:700;display:inline;" id="engagement-title">Large Bank</div> <span style="color:rgba(11,22,51,0.65);font-size:0.86rem;" id="engagement-industry">| Finance</span>
              <div style="margin-top:5px;font-size:0.86rem;"><span style="font-weight:600;">Role:</span> <span style="font-weight:700;" id="engagement-role">Senior Project Manager</span></div>
              <div style="margin-top:5px;font-size:0.86rem;"><span style="font-weight:600;">Skills:</span> <span style="color:rgba(11,22,51,0.9);" id="engagement-skills">Project Management, Risk & Compliance, Data Analytics</span></div>
              <div style="margin-top:6px;color:rgba(11,22,51,0.75);font-size:0.85rem;" id="engagement-desc">Led implementation of a compliance system for a major bank. Managed a team of 8 consultants.</div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px;display:flex;gap:12px;flex-wrap:nowrap;">
          <div style="background:#fbfbff;border-radius:10px;padding:12px;flex:1;min-width:0;border:1px solid rgba(11,22,51,0.03);">
            <div style="color:#1d4ed8;font-weight:700;margin-bottom:6px;font-size:0.9rem;">Client Reference</div>
              <div id="testimonial-client" style="font-size:0.9rem;font-style:italic;color:rgba(11,22,51,0.75);">‚ÄúAnna delivered excellent results on time.‚Äù</div>
              <div style="margin-top:6px;color:rgba(11,22,51,0.7);font-size:0.85rem;">‚Äî <span id="testimonial-client-author">Magnus S.</span>, <span style="font-style:italic;" id="testimonial-client-role">Risk Director</span></div>
          </div>
          <div style="background:#fbfbff;border-radius:10px;padding:12px;flex:1;min-width:0;border:1px solid rgba(11,22,51,0.03);">
            <div style="color:#16a34a;font-weight:700;margin-bottom:6px;font-size:0.9rem;">Manager Endorsement</div>
              <div id="testimonial-manager" style="font-size:0.9rem;font-style:italic;color:rgba(11,22,51,0.75);">‚ÄúGreat leader with strong strategic focus.‚Äù</div>
              <div style="margin-top:6px;color:rgba(11,22,51,0.7);font-size:0.85rem;">‚Äî <span id="testimonial-manager-author">Elin L.</span>, <span style="font-style:italic;" id="testimonial-manager-role">Consulting Director</span></div>
          </div>
          <div style="background:#fbfbff;border-radius:10px;padding:12px;flex:1;min-width:0;border:1px solid rgba(11,22,51,0.03);">
            <div style="color:#3b82f6;font-weight:700;margin-bottom:6px;font-size:0.9rem;">Team Feedback</div>
              <div id="testimonial-team" style="font-size:0.9rem;font-style:italic;color:rgba(11,22,51,0.75);">‚ÄúAnna is a fantastic team lead!‚Äù</div>
              <div style="margin-top:6px;color:rgba(11,22,51,0.7);font-size:0.85rem;">‚Äî <span id="testimonial-team-author">Erik J.</span>, <span style="font-style:italic;" id="testimonial-team-role">Data Analyst</span></div>
          </div>
        </div>
      </section>

        </div>

        <!-- Invite panel placed below the trust profile and sized to match the trust card container -->
        <aside class="card" style="max-width:1440px;width:100%;box-sizing:border-box;margin:14px auto;padding:20px;border-radius:12px;background:#fff;box-shadow:0 4px 18px rgba(0,0,0,0.05);">
          <h3 style="margin-top:0;margin-bottom:6px">Send feedback request</h3>
          <p class="tiny muted" style="margin-top:0;margin-bottom:12px">Quickly invite a reviewer to submit feedback for this engagement.</p>
          <form id="invite-form" autocomplete="off">
            <label style="display:block;margin-bottom:8px;font-weight:600">Consultant name
              <input id="inv-consultant-name" name="consultant_name" type="text" placeholder="Anna Larsson" style="width:100%;padding:8px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;" />
            </label>
            <label style="display:block;margin-bottom:8px">Title
              <input id="inv-consultant-title" name="consultant_title" type="text" placeholder="Senior Project Manager" style="width:100%;padding:8px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;" />
            </label>
            <label style="display:block;margin-bottom:8px">Company / engagement
              <input id="inv-company" name="company_client" type="text" placeholder="Large Bank" style="width:100%;padding:8px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;" />
            </label>
            <label style="display:block;margin-bottom:8px">Segment
              <input id="inv-segment" name="client_segment" type="text" placeholder="Finance" style="width:100%;padding:8px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;" />
            </label>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
              <input id="inv-start" name="start_month" type="text" placeholder="Start (e.g. Jan 2024)" style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:8px;" />
              <input id="inv-end" name="end_month" type="text" placeholder="End (e.g. Jun 2024)" style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:8px;" />
            </div>
            <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><input id="inv-ongoing" type="checkbox" /> Ongoing</label>
            <label style="display:block;margin-bottom:10px">Reviewer email
              <input id="inv-reviewer-email" name="reviewer_email" type="email" placeholder="reviewer@example.com" style="width:100%;padding:8px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;" required />
            </label>

            <label style="display:block;margin-bottom:8px">Message to Reviewer:
              <textarea id="inv-message" name="inv_message" placeholder="Hi Sarah,\n\nI hope you're doing well! I really enjoyed working together on our recent project. Could you please take a few minutes to fill out a quick review for me? All the details are already filled in, so it should be quick and easy.\n\nYour feedback means a lot to me for my PeerRate profile.\n\nThank you so much!\n- {{consultantName}}" style="width:100%;min-height:120px;padding:8px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;"></textarea>
            </label>

            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
              <label style="display:flex;align-items:center"><input type="checkbox" id="inv-include-link" checked /> A review link with the engagement details will be included in the email.</label>
            </div>

            <div style="display:flex;gap:8px;align-items:center;">
              <button id="inv-preview" type="button" class="secondary">Preview Email</button>
              <button id="inv-submit" class="primary" type="submit" style="flex:0 0 auto;">Send Request</button>
              <div id="inv-status" class="tiny muted" aria-live="polite"></div>
            </div>
          </form>
        </aside>

        <script>
        // Share button logic
        const shareBtn = document.getElementById('profile-share-btn');
        if (shareBtn) {
          shareBtn.addEventListener('click', function() {
            navigator.clipboard.writeText(window.location.href);
            shareBtn.textContent = 'Copied!';
            setTimeout(()=>shareBtn.textContent='Share PeerRate',1200);
          });
        }
        </script>

        <!-- 'Mitt omd√∂me' removed as requested -->

        <!-- 'My details' box removed as requested -->

        <!-- Externa data -->
        <section class="card" id="external-data-section">
          <h2>Externa data</h2>
          <p class="tiny muted">
            H√§r visas viss information som h√§mtats fr√•n externa, offentliga k√§llor kopplat till din profil.
            Uppgifterna uppdateras automatiskt med j√§mna mellanrum.
          </p>

          <ul class="profile-list">
            <li><span class="profile-label">Fordon (antal)</span><span class="profile-value" id="ext-vehicles-count"></span></li>
            <li><span class="profile-label">Fastigheter (antal)</span><span class="profile-value" id="ext-properties-count"></span></li>
            <li><span class="profile-label">Senast uppdaterad</span><span class="profile-value" id="ext-last-updated"></span></li>
            <li><span class="profile-label">Validerad adress</span><span class="profile-value"><span data-field="externalAddressLine">‚Äì</span></span></li>
            <li><span class="profile-label">Adressstatus</span><span class="profile-value"><span data-field="externalAddressStatus">‚Äì</span></span></li>
          </ul>
        </section>

        <!-- Feedback form (Trust Profile feedback) -->
        <section class="card" id="engagement-feedback-form">
          <h2>Provide feedback for this engagement</h2>
          <p class="tiny muted">You are providing feedback for the following engagement (read-only):</p>

          <!-- Invite sender: enter reviewer email to send questionnaire -->
          <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <input id="q-invite-email" type="email" placeholder="reviewer@example.com" style="flex:1;min-width:220px;padding:8px;border:1px solid #e5e7eb;border-radius:8px" />
            <button id="q-invite-send" class="secondary">Send questionnaire</button>
            <div id="q-invite-status" class="tiny muted" aria-live="polite"></div>
          </div>

          <div style="background:#fafafa;border:1px solid #e8eef6;padding:14px;border-radius:8px;margin-bottom:12px;">
            <div style="font-weight:700;" id="q-engagement-consultant">Anna Larsson</div>
            <div id="q-engagement-role" style="color:#555;margin-top:2px;">Senior Project Manager</div>
            <div id="q-engagement-type" style="color:#777;margin-top:6px;">Large Bank | Finance ‚Äî Jan 2024 - Jun 2024</div>
          </div>

          <div id="review-form-root"></div>
        </section>

        <!-- (Invite form moved to top of page) -->

        <!-- Logga ut -->
        <section class="card">
          <button id="logout-btn" type="button" class="secondary" data-i18n="profile_logout_btn">Logga ut</button>
        </section>

      </div>

      

      

      

      <div style="text-align:center;color:rgba(15,15,18,.55);font-size:12px;margin-top:18px;">
        ¬© 2025 by PeerRate.
      </div>
    </div>
  </main>

  <!-- ‚úÖ Viktigt: initiera spr√•k √§ven p√• profilsidan -->
  <!-- React + Babel (CDN) for the embedded review form component. Using UMD builds
       and babel-standalone here for a lightweight, no-build integration that keeps
       the rest of the app unchanged. In production you should prebuild a bundle. -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Inline React component (JSX via babel-standalone). This implements the
       review form per requirements: engagement details, ratings, qualitative
       feedback, verification & consent, and a submit flow with confirmation.
       It's intentionally self-contained and stores a draft in localStorage on
       submit. Replace with a prebuilt React bundle for production. -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    function StarRange({ label, name, min=1, max=5, value, onChange, tooltip='' }){
      return (
        <div style={{marginTop:10}}>
          <label style={{fontWeight:700}} title={tooltip}>{label}</label>
          <div style={{display:'flex',alignItems:'center',gap:8,marginTop:6}}>
            <input
              type="range"
              min={min}
              max={max}
              value={value}
              onChange={e => onChange(Number(e.target.value))}
              aria-label={label}
            />
            <div style={{minWidth:36,textAlign:'center',fontWeight:700}}>{value}</div>
          </div>
          <div className="tiny muted" style={{marginTop:4}}>{tooltip}</div>
        </div>
      );
    }

    function ReviewForm(){
      // prefill consultant name from DOM if available
      const initialConsultant = (document.getElementById('q-engagement-consultant') && document.getElementById('q-engagement-consultant').textContent) || '';

      const [consultant, setConsultant] = useState(initialConsultant);
      const [company, setCompany] = useState('');
      const [reviewerName, setReviewerName] = useState('');
      const [reviewerTitle, setReviewerTitle] = useState('');
      const [industry, setIndustry] = useState('Tech');
      const [engagementType, setEngagementType] = useState('Consultant');
      const [startDate, setStartDate] = useState('');
      const [endDate, setEndDate] = useState('');
      const [ongoing, setOngoing] = useState(false);

      // ratings
      const [overall, setOverall] = useState(5);
      const [collaboration, setCollaboration] = useState(5);
      const [expertise, setExpertise] = useState(5);
      const [communication, setCommunication] = useState(5);
      const [delivery, setDelivery] = useState(5);
      const [independence, setIndependence] = useState(5);

      const [whatWorked, setWhatWorked] = useState('');
      const [whatImprove, setWhatImprove] = useState('');
      const [recommend, setRecommend] = useState('yes');
      const [suitableFor, setSuitableFor] = useState('');

      const [workEmail, setWorkEmail] = useState('');
      const [confirmReal, setConfirmReal] = useState(false);
      const [consentPublic, setConsentPublic] = useState(false);

      const [submitting, setSubmitting] = useState(false);
      const [done, setDone] = useState(false);
      const [statusMsg, setStatusMsg] = useState('');

      useEffect(()=>{
        // If the engagement has a prefilled company from DOM, use it
        const engText = document.getElementById('q-engagement-type') && document.getElementById('q-engagement-type').textContent;
        if(engText && !company) setCompany(engText.split('|')[0].trim());
      },[]);

      function validate(){
        if(!consultant) return 'Consultant name is required.';
        if(!reviewerName) return 'Reviewer name is required.';
        if(!workEmail || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(workEmail)) return 'Valid work email is required.';
        if(!confirmReal) return 'You must confirm this review is based on a real engagement.';
        if(!consentPublic) return 'You must consent to the review being displayed publicly.';
        return null;
      }

      async function handleSubmit(e){
        e.preventDefault();
        const err = validate();
        if(err){ setStatusMsg(err); return; }
        setSubmitting(true);
        setStatusMsg('Submitting‚Ä¶');

        const payload = {
          consultant, company, reviewerName, reviewerTitle, industry, engagementType,
          startDate, endDate: ongoing ? null : endDate, ongoing,
          ratings: { overall, collaboration, expertise, communication, delivery, independence },
          whatWorked, whatImprove, recommend, suitableFor,
          workEmail, verified: false, consentPublic, confirmedReal: confirmReal,
          createdAt: new Date().toISOString(),
        };

        try{
          // Attempt to post to backend endpoint if available (best-effort).
          // Keep this optional ‚Äî many local dev instances lack a backend.
          let serverOk = false;
          try{
            const res = await fetch('/api/reviews', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload), credentials: 'include' });
            if(res && res.ok) serverOk = true;
          }catch(err){ /* ignore */ }

          // Persist locally as fallback/draft
          const key = 'peerRateReviewDraft';
          localStorage.setItem(key, JSON.stringify(payload));

          setDone(true);
          setStatusMsg(serverOk ? 'Thank you ‚Äî your review was submitted.' : 'Saved locally. Thank you ‚Äî verification pending.');
        }catch(err){
          setStatusMsg('Submission failed. Please try again.');
        }finally{
          setSubmitting(false);
        }
      }

      if(done){
        return (
          <div>
            <h3 style={{marginTop:0}}>Thank you ‚Äî review submitted</h3>
            <p className="tiny muted">We‚Äôve received your review. It will be marked as verified after email validation.</p>
            <div style={{marginTop:12}}><strong>Status:</strong> <span>{statusMsg}</span></div>
          </div>
        );
      }

      return (
        <form onSubmit={handleSubmit}>
          <h2 style={{marginTop:0}}>Provide feedback for this engagement</h2>
          <p className="tiny muted">Please complete the fields below. Work email is used only for verification.</p>

          <fieldset style={{border:0,padding:0,margin:0}}>
            <label style={{display:'block',fontWeight:700}}>Consultant‚Äôs Name (read-only)</label>
            <input type="text" value={consultant} readOnly style={{width:'100%',padding:8,marginTop:6}} />

            <label style={{display:'block',fontWeight:700,marginTop:8}}>Company Name</label>
            <input type="text" value={company} onChange={e=>setCompany(e.target.value)} style={{width:'100%',padding:8,marginTop:6}} />

            <label style={{display:'block',fontWeight:700,marginTop:8}}>Reviewer Name</label>
            <input type="text" value={reviewerName} onChange={e=>setReviewerName(e.target.value)} required style={{width:'100%',padding:8,marginTop:6}} />

            <label style={{display:'block',fontWeight:700,marginTop:8}}>Reviewer Title</label>
            <input type="text" value={reviewerTitle} onChange={e=>setReviewerTitle(e.target.value)} style={{width:'100%',padding:8,marginTop:6}} />

            <div style={{display:'flex',gap:8,marginTop:8}}>
              <div style={{flex:1}}>
                <label style={{display:'block',fontWeight:700}}>Industry / Segment</label>
                <select value={industry} onChange={e=>setIndustry(e.target.value)} style={{width:'100%',padding:8,marginTop:6}}>
                  <option>Tech</option>
                  <option>Finance</option>
                  <option>Healthcare</option>
                  <option>Startup</option>
                  <option>Enterprise</option>
                  <option>Other</option>
                </select>
              </div>
              <div style={{flex:1}}>
                <label style={{display:'block',fontWeight:700}}>Engagement Type</label>
                <select value={engagementType} onChange={e=>setEngagementType(e.target.value)} style={{width:'100%',padding:8,marginTop:6}}>
                  <option>Consultant</option>
                  <option>Contractor</option>
                  <option>Interim</option>
                  <option>Project-based</option>
                  <option>Freelancer</option>
                  <option>Employee</option>
                </select>
              </div>
            </div>

            <div style={{display:'flex',gap:8,marginTop:8,alignItems:'center'}}>
              <div style={{flex:1}}>
                <label style={{display:'block',fontWeight:700}}>Start Date</label>
                <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} style={{width:'100%',padding:8,marginTop:6}} />
              </div>
              <div style={{flex:1}}>
                <label style={{display:'block',fontWeight:700}}>End Date</label>
                <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} disabled={ongoing} style={{width:'100%',padding:8,marginTop:6}} />
              </div>
              <div style={{display:'flex',alignItems:'center'}}>
                <label style={{marginLeft:6}}><input type="checkbox" checked={ongoing} onChange={e=>setOngoing(e.target.checked)} /> Ongoing</label>
              </div>
            </div>
          </fieldset>

          <hr style={{margin:'14px 0'}} />

          <h3 style={{marginBottom:6}}>Ratings</h3>
          <StarRange label="Overall Rating" value={overall} onChange={setOverall} tooltip="Overall delivery quality (1‚Äì5)." />
          <StarRange label="Collaboration" value={collaboration} onChange={setCollaboration} tooltip="Working with others, team fit." />
          <StarRange label="Professional Expertise" value={expertise} onChange={setExpertise} tooltip="Domain knowledge and skills." />
          <StarRange label="Communication" value={communication} onChange={setCommunication} tooltip="Clarity and responsiveness." />
          <StarRange label="Delivery / Reliability" value={delivery} onChange={setDelivery} tooltip="On-time delivery and follow-through." />
          <StarRange label="Level of Independence" value={independence} onChange={setIndependence} tooltip="Ability to run with minimal supervision." />

          <hr style={{margin:'14px 0'}} />

          <div>
            <label style={{fontWeight:700}}>What worked particularly well? (max 500 chars)</label>
            <textarea value={whatWorked} onChange={e=>setWhatWorked(e.target.value.slice(0,500))} style={{width:'100%',minHeight:100,marginTop:6}} />
          </div>

          <div style={{marginTop:10}}>
            <label style={{fontWeight:700}}>Is there anything that could have been improved? (optional)</label>
            <textarea value={whatImprove} onChange={e=>setWhatImprove(e.target.value.slice(0,500))} style={{width:'100%',minHeight:80,marginTop:6}} />
          </div>

          <div style={{marginTop:10}}>
            <label style={{fontWeight:700}}>Would you recommend this person to others?</label>
            <div style={{marginTop:6}}>
              <label><input type="radio" name="recommend" value="yes" checked={recommend==='yes'} onChange={e=>setRecommend('yes')} /> Yes</label>
              <label style={{marginLeft:12}}><input type="radio" name="recommend" value="no" checked={recommend==='no'} onChange={e=>setRecommend('no')} /> No</label>
            </div>
            {recommend==='yes' && (
              <div style={{marginTop:8}}>What types of engagements is this person best suited for? (tags or short text)
                <input type="text" value={suitableFor} onChange={e=>setSuitableFor(e.target.value)} placeholder="e.g. Project-based, Interim, Long-term" style={{width:'100%',padding:8,marginTop:6}} />
              </div>
            )}
          </div>

          <hr style={{margin:'14px 0'}} />

          <div>
            <p className="tiny muted">Work Email (used only for verification, not publicly visible)</p>
            <input type="email" value={workEmail} onChange={e=>setWorkEmail(e.target.value)} required style={{width:'100%',padding:8,marginTop:6}} />
          </div>

          <div style={{marginTop:10}}>
            <label><input type="checkbox" checked={confirmReal} onChange={e=>setConfirmReal(e.target.checked)} required /> I confirm this review is based on a real professional engagement.</label>
          </div>
          <div style={{marginTop:6}}>
            <label><input type="checkbox" checked={consentPublic} onChange={e=>setConsentPublic(e.target.checked)} required /> I consent to this review being displayed publicly.</label>
          </div>

          <div style={{marginTop:14,display:'flex',gap:12,alignItems:'center'}}>
            <button type="submit" className="primary" disabled={submitting}>Submit Review</button>
            <div className="tiny muted" aria-live="polite">{statusMsg}</div>
          </div>
        </form>
      );
    }

    // mount the component
    document.addEventListener('DOMContentLoaded', function(){
      const root = document.getElementById('review-form-root');
      if(root) ReactDOM.createRoot(root).render(React.createElement(ReviewForm));
    });
  </script>

  <script type="module">
    import { initLandingLanguage } from '/modules/landing/language.js';
    initLandingLanguage();
  </script>

  <script type="module" src="/modules/main.js"></script>
</body>
</html>
