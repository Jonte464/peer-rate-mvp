<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PeerRate</title>
  <style>
    :root{
      --brand-orange:#f6a94b;
      --brand-card:#fbf2e6;
      --brand-accent:#bfe9e6;
      --brand-border:#eadfce;
      --brand-ink:#1e1830;
      --brand-ink-d:#4a425e;
      --brand-purple:#1b1533;
      --ok:#0b7a65;
      --err:#9b1c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--brand-ink);
      background:linear-gradient(180deg,var(--brand-orange) 0 56vh,var(--brand-accent) 56vh 100%);
    }
    .wrap{max-width:960px;margin-inline:auto;padding:28px 24px}
    h1{margin:0 0 12px}
    .grid{display:grid;gap:20px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}

    .card{
      background:var(--brand-card);
      border:1px solid var(--brand-border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }
    label{display:block;font-weight:700;margin:12px 0 6px}
    input,select,textarea,button{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #d9cbb7;background:#fff;color:var(--brand-ink);font:inherit;
    }
    input::placeholder,textarea::placeholder{color:#9b8f87}
    textarea{min-height:110px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1}
    .muted{color:var(--brand-ink-d);font-size:14px}
    .help{color:var(--brand-ink-d);font-size:12px;margin-top:6px}

    button.primary{background:var(--brand-purple);color:#fff;border:0;cursor:pointer;font-weight:800}
    button.primary:hover{filter:brightness(1.05)}
    button.secondary{background:#fff;color:var(--brand-ink);border:1px solid var(--brand-border)}

    /* Notis/feedback */
    .notice{
      display:none;margin-top:12px;border-radius:12px;padding:12px 14px;font-weight:600;
      border:1px solid transparent;
    }
    .notice.ok{display:block;background:#e7f5f1;border-color:#bde6db;color:var(--ok)}
    .notice.err{display:block;background:#fdecec;border-color:#f6c4c4;color:var(--err)}

    /* Rapport-sektion */
    .report-box{display:none;border:1px solid var(--brand-border);background:#fff;padding:12px;border-radius:12px;margin-top:8px}
    .tiny{font-size:12px}
    .files-note{font-size:12px;color:var(--brand-ink-d);margin-top:6px}
    .file-list{margin:6px 0 0;padding:0;list-style:none}
    .file-list li{font-size:12px;color:var(--brand-ink-d)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PeerRate</h1>

    <div class="grid">
      <!-- LÄMNA BETYG -->
      <section class="card">
        <h2>Lämna ett betyg</h2>
        <form id="rate-form" autocomplete="off">
          <label for="subject">Vem betygsätter du? <span class="tiny">(användarnamn eller mejl)</span></label>
          <input id="subject" type="text" placeholder="erik@example.com" required />

          <label for="rater">Ditt namn/mejl <span class="tiny">(valfritt)</span></label>
          <input id="rater" type="text" placeholder="Anders" />

          <label for="rating">Betyg (1–5)</label>
          <select id="rating" required>
            <option value="">Välj betyg</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>

          <label for="comment">Kommentar <span class="tiny">(valfritt)</span></label>
          <textarea id="comment" placeholder=""></textarea>

          <label for="proofRef">Verifierings-ID <span class="tiny">(valfritt, t.ex. ordernr)</span></label>
          <input id="proofRef" type="text" placeholder="ORDER-123" />

          <!-- RAPPORTERA BEDRÄGERI -->
          <div class="field" style="margin-top:12px">
            <label style="font-weight:600">
              <!-- Inline onchange som alltid funkar -->
              <input type="checkbox" id="reportFlag" onchange="toggleReport(this.checked)" />
              Rapportera misstänkt bedrägeri
            </label>
            <div class="help">Markera vid misstanke om bedrägeri/allvarligt regelbrott. Vi granskar ärendet och kan kontakta dig.</div>
          </div>

          <div id="reportDetails" class="report-box">
            <label for="reportReason">Typ av problem</label>
            <select id="reportReason" disabled required>
              <option value="">Välj...</option>
              <option>Misstänkt bedrägeri</option>
              <option>Vilseledande identitet</option>
              <option>Obetald/utebliven leverans</option>
              <option>Falsk/felaktigt beskriven vara/tjänst</option>
              <option>Otillåten betalningsmetod/chargeback-abuse</option>
              <option>Annan oegentlighet</option>
            </select>

            <label for="reportWhen" style="margin-top:8px">Tidpunkt</label>
            <input id="reportWhen" type="datetime-local" disabled />

            <div class="row" style="margin-top:8px">
              <div>
                <label for="reportAmount">Belopp (SEK) <span class="tiny">(valfritt)</span></label>
                <input id="reportAmount" type="number" min="0" step="1" placeholder="t.ex. 1200" disabled />
              </div>
              <div>
                <label for="reportLink">Motpart/annonslänk <span class="tiny">(valfritt)</span></label>
                <input id="reportLink" type="url" placeholder="https://annons-eller-profil" disabled />
              </div>
            </div>

            <label for="reportText" style="margin-top:8px">Beskrivning</label>
            <textarea id="reportText" rows="4" placeholder="Beskriv kort vad som hänt, inkl. datum/ev. belopp." disabled required></textarea>

            <label for="evidenceUrl" style="margin-top:8px">Bevislänk <span class="tiny">(valfritt)</span></label>
            <input type="url" id="evidenceUrl" placeholder="https://… (kvitto, order, chatt, e-post)" disabled />

            <label for="reportFiles" style="margin-top:8px">Ladda upp bevis <span class="tiny">(valfritt)</span></label>
            <input id="reportFiles" type="file" accept=".jpg,.jpeg,.png,.pdf" multiple disabled />
            <div class="files-note">Upp till 3 filer, max 2 MB/st. jpg/png/pdf.</div>
            <ul id="fileList" class="file-list"></ul>

            <label style="margin-top:8px;font-weight:600">
              <input type="checkbox" id="reportConsent" disabled />
              Jag intygar att uppgifterna är korrekta efter bästa förmåga och förstår att falska anmälningar kan leda till avstängning.
            </label>
          </div>
          <!-- /RAPPORTERA BEDRÄGERI -->

          <div class="row" style="margin-top:12px">
            <button class="primary" type="submit">Skicka betyg</button>
            <button class="secondary" type="button" id="reset-form">Avbryt</button>
          </div>

          <!-- Användarvänlig feedback-notis -->
          <div id="notice" class="notice"></div>
        </form>
      </section>

      <!-- LÄS BETYG -->
      <section class="card">
        <h2>Läs betyg</h2>
        <div class="row">
          <input id="lookup-subject" type="text" placeholder="erik@example.com" />
          <button class="primary" id="btn-lookup" type="button">Sök</button>
        </div>
        <p class="muted">Visar snitt och senaste betyg för vald mottagare.</p>
        <div id="avg-box" class="muted"></div>
        <ul id="list-box" class="clean" style="list-style:none;padding:0;margin:10px 0"></ul>
        <hr style="margin:14px 0;border:0;border-top:1px solid var(--brand-border)" />
        <div class="row">
          <button id="btn-recent" class="secondary" type="button">Visa senaste 20 (alla)</button>
        </div>
        <ul id="recent-box" class="clean" style="list-style:none;padding:0;margin:10px 0"></ul>
      </section>
    </div>
  </div>

  <script>
    // Gör toggle robust via inline onchange OCH fallback-listener
    function toggleReport(on){
      const details = document.getElementById('reportDetails');
      const fields = [
        'reportReason','reportWhen','reportAmount','reportLink',
        'reportText','evidenceUrl','reportConsent','reportFiles'
      ].map(id => document.getElementById(id));
      if (!details) return;
      details.style.display = on ? 'block' : 'none';
      fields.forEach(x => { if (x) x.disabled = !on; });
      if (!on){
        const rr = document.getElementById('reportReason');
        const rw = document.getElementById('reportWhen');
        const ra = document.getElementById('reportAmount');
        const rl = document.getElementById('reportLink');
        const rt = document.getElementById('reportText');
        const eu = document.getElementById('evidenceUrl');
        const rc = document.getElementById('reportConsent');
        const rf = document.getElementById('reportFiles');
        const fl = document.getElementById('fileList');
        if (rr) rr.value = '';
        if (rw) rw.value = '';
        if (ra) ra.value = '';
        if (rl) rl.value = '';
        if (rt) rt.value = '';
        if (eu) eu.value = '';
        if (rc) rc.checked = false;
        if (rf) rf.value = '';
        if (fl) fl.innerHTML = '';
      }
    }

    const el = (id) => document.getElementById(id);
    const api = {
      create: (payload) => fetch('/api/ratings', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r => r.json()),
      list: (subject) => fetch('/api/ratings?subject=' + encodeURIComponent(subject)).then(r => r.json()),
      avg: (subject) => fetch('/api/ratings/average?subject=' + encodeURIComponent(subject)).then(r => r.json()),
      recent: () => fetch('/api/ratings/recent').then(r => r.json())
    };

    let noticeTimer=null;
    function showNotice(ok, msg){
      const box = el('notice');
      box.className = 'notice ' + (ok ? 'ok' : 'err');
      box.textContent = msg;
      clearTimeout(noticeTimer);
      noticeTimer = setTimeout(() => { box.className='notice'; box.textContent=''; }, 6000);
    }
    function clearNotice(){
      const box = el('notice');
      clearTimeout(noticeTimer);
      box.className = 'notice';
      box.textContent = '';
    }

    // Filer
    const filesInput = document.getElementById('reportFiles');
    const fileList = document.getElementById('fileList');
    function readFiles(){
      if (!filesInput || !fileList) return Promise.resolve([]);
      fileList.innerHTML='';
      const files = Array.from(filesInput.files||[]);
      const limited = files.slice(0,3);
      const over = files.length>3;
      if (over) showNotice(false,'Max tre filer – övriga ignoreras.');
      limited.forEach(f=>{
        const li = document.createElement('li');
        li.textContent = `${f.name} (${Math.round(f.size/1024)} kB)`;
        fileList.appendChild(li);
      });
      return Promise.all(limited.map(f => new Promise((resolve)=>{
        if (f.size > 2*1024*1024){ // 2 MB
          showNotice(false, `${f.name} är större än 2 MB och ignoreras.`);
          return resolve(null);
        }
        const reader = new FileReader();
        reader.onload = () => resolve({name:f.name,type:f.type,size:f.size,data:String(reader.result).split(',')[1]});
        reader.onerror = () => resolve(null);
        reader.readAsDataURL(f);
      }))).then(arr => arr.filter(Boolean));
    }

    // Fallback-listener om inline av någon anledning inte körs
    document.addEventListener('DOMContentLoaded', () => {
      const flag = el('reportFlag');
      if (flag) {
        flag.addEventListener('change', () => toggleReport(flag.checked));
      }
    });

    // Skicka betyg
    el('rate-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearNotice();

      const subject = el('subject').value.trim();
      const rater   = el('rater').value.trim();
      const ratingRaw = el('rating').value;
      const rating  = parseInt(ratingRaw, 10);
      const comment = el('comment').value.trim();
      const proofRef= el('proofRef').value.trim();

      if (!subject) return showNotice(false,'Fyll i vem du betygsätter.');
      if (!ratingRaw || !Number.isInteger(rating) || rating < 1 || rating > 5)
        return showNotice(false,'Välj betyg 1–5.');

      const flag = el('reportFlag');
      let reportPayload = null;

      if (flag && flag.checked){
        const reason = el('reportReason').value;
        const when   = el('reportWhen').value;
        const amount = el('reportAmount').value;
        const link   = el('reportLink').value.trim();
        const rtext  = el('reportText').value.trim();
        const evid   = el('evidenceUrl').value.trim();
        const cons   = el('reportConsent').checked;

        if (!cons) return showNotice(false,'Bocka i intygandet under rapportering.');
        if (!reason) return showNotice(false,'Välj typ av problem.');
        if (!rtext)  return showNotice(false,'Beskriv händelsen kort.');

        const filesPayload = await readFiles();

        reportPayload = {
          report_flag: true,
          report_reason: reason,
          report_when: when || null,
          report_amount_sek: amount ? Number(amount) : null,
          report_link: link || null,
          report_text: rtext,
          evidence_url: evid || null,
          report_consent: !!cons,
          report_files: filesPayload
        };
      }

      try {
        const res = await api.create({
          subject, rating, comment, rater, proofRef,
          ...(reportPayload ? { report: reportPayload } : {})
        });

        if (res && res.ok){
          showNotice(true,'Tack för ditt omdöme – det har skickats.');
          e.target.reset();
          el('rating').value = ''; // återställ till "Välj betyg"
          toggleReport(false);

          if (el('lookup-subject').value.trim().toLowerCase() === subject.toLowerCase()) {
            doLookup();
          }
        } else {
          showNotice(false, res?.error || 'Något gick fel. Försök igen.');
        }
      } catch {
        showNotice(false,'Nätverksfel. Försök igen.');
      }
    });

    el('reset-form').addEventListener('click', () => {
      el('rate-form').reset();
      el('rating').value = '';
      toggleReport(false);
      clearNotice();
    });

    // Läs betyg
    const doLookup = async () => {
      const s = el('lookup-subject').value.trim();
      if (!s){ el('avg-box').textContent=''; el('list-box').innerHTML=''; return; }
      const [avg, list] = await Promise.all([ 
        fetch('/api/ratings/average?subject=' + encodeURIComponent(s)).then(r=>r.json()),
        fetch('/api/ratings?subject=' + encodeURIComponent(s)).then(r=>r.json())
      ]);
      el('avg-box').innerHTML = avg.ok
        ? `<strong>Snitt:</strong> ${avg.average} (${avg.count} st)`
        : `<span style="color:var(--err);font-weight:700">${avg.error || 'Fel'}</span>`;

      if (list.ok){
        el('list-box').innerHTML = list.ratings.map(it =>
          `<li><strong>${it.rating}/5</strong> – ${escapeHtml(it.comment || '')}
           <div class="tiny muted">ID: ${it.id} • ${new Date(it.createdAt).toLocaleString()}${it.raterMasked ? ' • ' + it.raterMasked : ''}</div></li>`
        ).join('') || '<li class="muted">Inga betyg ännu.</li>';
      } else {
        el('list-box').innerHTML = `<li style="color:var(--err);font-weight:700">${list.error || 'Fel'}</li>`;
      }
    };
    document.getElementById('btn-lookup').addEventListener('click', doLookup);

    document.getElementById('btn-recent').addEventListener('click', async () => {
      const r = await fetch('/api/ratings/recent').then(x=>x.json());
      const box = document.getElementById('recent-box');
      box.innerHTML = r.ok
        ? r.ratings.map(it =>
            `<li><strong>${it.rating}/5</strong> – ${escapeHtml(it.comment || '')}
               <div class="tiny muted">${escapeHtml(it.subject)} • ${new Date(it.createdAt).toLocaleString()}</div></li>`
          ).join('') || '<li class="muted">Inget ännu.</li>'
        : `<li style="color:var(--err);font-weight:700">${r.error || 'Fel'}</li>`;
    });

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
    }
  </script>
</body>
</html>
