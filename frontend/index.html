<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PeerRate</title>
  <style>
    :root{
      /* Färgtema matchat till hemsidan */
      --brand-orange: #f6a94b;   /* hero-bakgrund */
      --brand-cream:  #f9f4ec;   /* ljus bakgrund */
      --brand-card:   #fbf2e6;   /* kort/sektioner */
      --brand-ink:    #1e1830;   /* mörk text */
      --brand-ink-d:  #4a425e;   /* dämpad text */
      --brand-purple: #1b1533;   /* primär knapp */
      --brand-accent: #bfe9e6;   /* ljus mint/blå del */
      --brand-border: #eadfce;   /* linjer */
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--brand-ink);
      /* Orange överdel + mint nedre del för hemside-känslan */
      background:
        linear-gradient(180deg, var(--brand-orange) 0 56vh, var(--brand-accent) 56vh 100%);
    }
    .wrap{max-width:960px;margin-inline:auto;padding:28px 24px}
    h1{margin:0 0 12px 0}
    .grid{display:grid;gap:20px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--brand-card);
      border:1px solid var(--brand-border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }

    label{display:block;font-weight:700;margin:12px 0 6px 0}
    input,select,textarea,button{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #d9cbb7;
      background:#fff;
      color:var(--brand-ink);
      font:inherit;
    }
    input::placeholder, textarea::placeholder{color:#9b8f87}
    textarea{min-height:110px;resize:vertical}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}

    button.primary{
      background:var(--brand-purple);
      color:#fff;
      border:0;
      cursor:pointer;
      font-weight:800;
    }
    button.primary:hover{filter:brightness(1.05)}
    button.secondary{
      background:#fff;
      color:var(--brand-ink);
      border:1px solid var(--brand-border);
    }

    .muted{color:var(--brand-ink-d);font-size:14px}
    .help{color:var(--brand-ink-d);font-size:12px;margin-top:6px}

    pre{
      margin:12px 0 0 0;
      background:var(--brand-ink);
      color:#e6e7ea;
      padding:14px;
      border-radius:12px;
      overflow:auto;
      max-height:220px;
    }
    ul.clean{list-style:none;padding:0;margin:10px 0}
    ul.clean li{padding:10px;border-bottom:1px solid var(--brand-border)}
    .ok{color:#0b7a65;font-weight:700}
    .err{color:#991b1b;font-weight:700}
    .tiny{font-size:12px}

    .report-box{
      display:none;
      border:1px solid var(--brand-border);
      background:#fff;
      padding:12px;
      border-radius:12px;
      margin-top:8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PeerRate</h1>

    <div class="grid">
      <!-- LÄMNA BETYG -->
      <section class="card">
        <h2>Lämna ett betyg</h2>
        <form id="rate-form" autocomplete="off">
          <label for="subject">Vem betygsätter du? <span class="tiny">(användarnamn eller mejl)</span></label>
          <input id="subject" type="text" placeholder="erik@example.com" required />

          <label for="rater">Ditt namn/mejl <span class="tiny">(valfritt)</span></label>
          <input id="rater" type="text" placeholder="" />

          <label for="rating">Betyg (1–5)</label>
          <select id="rating" required>
            <option value="">Välj betyg</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>

          <label for="comment">Kommentar <span class="tiny">(valfritt)</span></label>
          <textarea id="comment" placeholder=""></textarea>

          <label for="proofRef">Verifierings-ID <span class="tiny">(valfritt, t.ex. ordernr)</span></label>
          <input id="proofRef" type="text" placeholder="ORDER-123" />

          <!-- RAPPORTERA BEDRÄGERI -->
          <div class="field" style="margin-top:12px">
            <label style="font-weight:600">
              <input type="checkbox" id="reportFlag" />
              Rapportera misstänkt bedrägeri
            </label>
            <div class="help">Markera om du anser att händelsen rör bedrägeri eller allvarligt regelbrott. Vi granskar ärendet och kan kontakta dig för förtydliganden.</div>
          </div>

          <div id="reportDetails" class="report-box">
            <label for="reportReason">Typ av problem</label>
            <select id="reportReason" disabled>
              <option value="">Välj...</option>
              <option>Misstänkt bedrägeri</option>
              <option>Vilseledande identitet</option>
              <option>Obetald/utebliven leverans</option>
              <option>Falsk eller felaktigt beskriven vara/tjänst</option>
              <option>Otillåten betalningsmetod/”chargeback abuse”</option>
              <option>Annat (specificera)</option>
            </select>

            <label for="reportText" style="margin-top:8px">Beskrivning</label>
            <textarea id="reportText" rows="4" placeholder="Beskriv kort vad som hänt, inkl. datum och belopp om möjligt." disabled></textarea>

            <label for="evidenceUrl" style="margin-top:8px">Bevislänk (valfritt)</label>
            <input type="url" id="evidenceUrl" placeholder="https://... (kvitto, order, chatt, e-post)" disabled />

            <label style="margin-top:8px;font-weight:600">
              <input type="checkbox" id="reportConsent" disabled />
              Jag intygar att uppgifterna är korrekta efter bästa förmåga och förstår att falska anmälningar kan leda till avstängning.
            </label>
          </div>
          <!-- /RAPPORTERA BEDRÄGERI -->

          <div class="row" style="margin-top:12px">
            <button class="primary" type="submit">Skicka betyg</button>
            <button class="secondary" type="button" id="reset-form">Avbryt</button>
          </div>
        </form>
        <pre id="rate-result" class="muted">// svar visas här</pre>
      </section>

      <!-- LÄS BETYG -->
      <section class="card">
        <h2>Läs betyg</h2>
        <div class="row">
          <input id="lookup-subject" type="text" placeholder="erik@example.com" />
          <button class="primary" id="btn-lookup" type="button">Sök</button>
        </div>
        <p class="muted">Visar snitt och senaste betyg för vald mottagare.</p>
        <div id="avg-box" class="muted"></div>
        <ul id="list-box" class="clean"></ul>
        <hr style="margin:14px 0;border:0;border-top:1px solid var(--brand-border)" />
        <div class="row">
          <button id="btn-recent" class="secondary" type="button">Visa senaste 20 (alla)</button>
        </div>
        <ul id="recent-box" class="clean"></ul>
      </section>
    </div>
  </div>

  <script>
    // --- helpers ---
    const el = (id) => document.getElementById(id);
    const api = {
      create: (payload) => fetch('/api/ratings', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r => r.json()),
      list: (subject) => fetch('/api/ratings?subject=' + encodeURIComponent(subject)).then(r => r.json()),
      avg: (subject) => fetch('/api/ratings/average?subject=' + encodeURIComponent(subject)).then(r => r.json()),
      recent: () => fetch('/api/ratings/recent').then(r => r.json())
    };

    // --- Rapportera: UI toggling ---
    const flag = el('reportFlag');
    const details = el('reportDetails');
    const reason = el('reportReason');
    const rtext  = el('reportText');
    const evid   = el('evidenceUrl');
    const cons   = el('reportConsent');

    flag.addEventListener('change', () => {
      const on = flag.checked;
      details.style.display = on ? 'block' : 'none';
      [reason, rtext, evid, cons].forEach(x => x.disabled = !on);
      reason.required = on;
      rtext.required  = on;
      cons.required   = on;
      if (!on){
        reason.value = '';
        rtext.value  = '';
        evid.value   = '';
        cons.checked = false;
      }
    });

    function collectReportPayload(){
      if (!flag.checked) return null;
      return {
        report_flag: true,
        report_reason: reason.value,
        report_text: rtext.value.trim(),
        evidence_url: evid.value.trim() || null,
        report_consent: !!cons.checked
      };
    }

    // --- LÄMNA BETYG ---
    el('rate-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const subject = el('subject').value.trim();
      const rater   = el('rater').value.trim();
      const ratingRaw = el('rating').value;
      const rating  = parseInt(ratingRaw, 10);
      const comment = el('comment').value.trim();
      const proofRef= el('proofRef').value.trim();

      if (!subject) return showRate({ ok:false, error:'Fyll i vem du betygsätter (subject).' });
      if (!ratingRaw || !Number.isInteger(rating) || rating < 1 || rating > 5)
        return showRate({ ok:false, error:'Välj betyg 1–5.' });

      // Om rapport-läge är aktivt, kräver vi samtycke
      if (flag.checked && !cons.checked){
        return showRate({ ok:false, error:'Bocka i intygandet under rapportering.' });
      }

      const reportPayload = collectReportPayload();

      try {
        const res = await api.create({
          subject, rating, comment, rater, proofRef,
          ...(reportPayload ? { report: reportPayload } : {})
        });
        showRate(res);
        if (res.ok) {
          e.target.reset();
          el('rating').value = ''; // återställ till "Välj betyg"
          // Återställ rapportsektionen
          flag.checked = false;
          flag.dispatchEvent(new Event('change'));

          // uppdatera ev. läsvyn om samma subject
          if (el('lookup-subject').value.trim().toLowerCase() === subject.toLowerCase()) {
            doLookup();
          }
        }
      } catch {
        showRate({ ok:false, error:'Nätverksfel. Försök igen.' });
      }
    });

    el('reset-form').addEventListener('click', () => {
      el('rate-form').reset();
      el('rating').value = ''; // inget förvalt
      flag.checked = false;
      flag.dispatchEvent(new Event('change'));
      el('rate-result').textContent = '// svar visas här';
      el('rate-result').className = 'muted';
    });

    function showRate(data){
      el('rate-result').textContent = JSON.stringify(data, null, 2);
      el('rate-result').className = data.ok ? 'ok' : 'err';
    }

    // --- LÄS BETYG ---
    el('btn-lookup').addEventListener('click', doLookup);
    async function doLookup(){
      const s = el('lookup-subject').value.trim();
      if (!s) { el('avg-box').textContent=''; el('list-box').innerHTML=''; return; }
      const [avg, list] = await Promise.all([ api.avg(s), api.list(s) ]);
      el('avg-box').innerHTML = avg.ok
        ? `<strong>Snitt:</strong> ${avg.average} (${avg.count} st)`
        : `<span class="err">${avg.error || 'Fel'}</span>`;

      if (list.ok){
        el('list-box').innerHTML = list.ratings.map(it =>
          `<li><strong>${it.rating}/5</strong> – ${escapeHtml(it.comment || '')}
           <div class="tiny muted">ID: ${it.id} • ${new Date(it.createdAt).toLocaleString()}${it.raterMasked ? ' • ' + it.raterMasked : ''}</div></li>`
        ).join('') || '<li class="muted">Inga betyg ännu.</li>';
      } else {
        el('list-box').innerHTML = `<li class="err">${list.error || 'Fel'}</li>`;
      }
    }

    el('btn-recent').addEventListener('click', async () => {
      const r = await api.recent();
      el('recent-box').innerHTML = r.ok
        ? r.ratings.map(it =>
            `<li><strong>${it.rating}/5</strong> – ${escapeHtml(it.comment || '')}
               <div class="tiny muted">${escapeHtml(it.subject)} • ${new Date(it.createdAt).toLocaleString()}</div></li>`
          ).join('') || '<li class="muted">Inget ännu.</li>'
        : `<li class="err">${r.error || 'Fel'}</li>`;
    });

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, ch => (
        { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[ch]
      ));
    }
  </script>
</body>
</html>
