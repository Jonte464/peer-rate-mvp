// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * Kunder/anv√§ndare (registrera dig-formul√§ret)
 */
model Customer {
  id             String   @id @default(uuid())
  subjectRef     String   @unique        // anv√§nds som "konto-id", vi s√§tter detta = email (lowercase)
  fullName       String?
  personalNumber String?  @unique
  email          String?  @unique
  phone          String?
  addressStreet  String?
  addressZip     String?
  addressCity    String?
  country        String?

  // NYTT: l√∂senord (hashat, aldrig klartext)
  passwordHash   String?

  // NYTT: samtycke till inh√§mtning fr√•n tredje part
  thirdPartyConsent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ratings      Rating[]
  reports      Report[]      @relation("CustomerReports")
  score        Score?
  transactions Transaction[]
  termsAccepted Boolean @default(false)

  // NYTT: externa profiler (Blocket, Tradera m.fl.)
  externalProfiles ExternalProfile[]

  // NYTT: aff√§rsh√§ndelser (deals) d√§r kunden √§r s√§ljare eller k√∂pare
  dealsAsSeller Deal[] @relation("CustomerDealsAsSeller")
  dealsAsBuyer  Deal[] @relation("CustomerDealsAsBuyer")
}

/**
 * Transaktioner kopplade till kund (valfritt att koppla rating/rapport hit).
 */
model Transaction {
  id          String    @id @default(uuid())
  customerId  String
  amount      Decimal?  @db.Decimal(12, 2)
  currency    String?   @default("SEK")
  occurredAt  DateTime?
  externalRef String?
  evidenceUrl String?

  ratings     Rating[]
  reports     Report[]
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

/**
 * Enskilt betyg.
 */
model Rating {
  id            String  @id @default(uuid())
  customerId    String
  transactionId String?

  // NYTT: koppling till aff√§rsh√§ndelse (Deal)
  dealId        String?

  // Betyg 1‚Äì5
  score Int

  // NYTT: varifr√•n detta betyg kommer (Blocket, Tradera, osv)
  ratingSource RatingSource @default(OTHER)

  // Kommentar (fr√•n formul√§rets kommentarsf√§lt)
  text String?

  // Ditt namn/e-post (fr√•n "Ditt namn/mejl")
  raterName  String?
  raterEmail String? // Om anv√§ndaren skriver in e-post

  // Verifierings-ID (t.ex. ORDER-123)
  verificationId String?

  // Historiskt f√§lt ‚Äì l√§mnas kvar f√∂r bak√•tkomp.
  proofRef String?

  // Om kryssrutan "Rapportera misst√§nkt bedr√§geri" var ikryssad
  reportedSuspectedFraud Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer    Customer     @relation(fields: [customerId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  // NYTT: relation till Deal
  deal        Deal?        @relation(fields: [dealId], references: [id])

  // En rating kan ha 0..n rapporter kopplade
  reports Report[]

  @@index([customerId])
  @@index([transactionId])
  @@index([dealId])
  @@index([createdAt])
}

/**
 * Sammanv√§gd po√§ng (framtida).
 */
model Score {
  customerId String   @id
  trustScore Int
  breakdown  Json
  updatedAt  DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id])
}

/**
 * Rapport om misst√§nkt bedr√§geri/avvikelse.
 * H√§r lagras samtliga f√§lt fr√•n "Rapportera misst√§nkt bedr√§geri",
 * inkl. tidpunkt, belopp, valfri l√§nk, samtycke och bilagor.
 */
model Report {
  id String @id @default(uuid())

  // Vem rapporten g√§ller (den som blev betygsatt)
  reportedCustomerId String

  // Kopplingar (valfria) om rapporten kommer ihop med viss transaktion/betyg
  transactionId String?
  ratingId      String?

  // Typ av problem (fr√•n "Typ av problem")
  reason ReportReason

  // Beskrivning (fr√•n "Beskrivning")
  details String?

  // Bevisl√§nk (fr√•n "Bevisl√§nk")
  evidenceUrl String?

  // Verifierings-ID (kan speglas fr√•n rating vid behov)
  verificationId String?

  // Tidpunkt d√• h√§ndelsen intr√§ffade (fr√•n datetime-local)
  occurredAt DateTime?

  // Belopp + valuta (default SEK)
  amount   Decimal? @db.Decimal(12, 2)
  currency String?  @default("SEK")

  // L√§nk till motpart/annons/profil
  counterpartyLink String?

  // Samtycke att uppgifterna √§r korrekta
  reporterConsent Boolean? @default(false)

  status    ReportStatus @default(OPEN)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  rating           Rating?      @relation(fields: [ratingId], references: [id])
  reportedCustomer Customer     @relation("CustomerReports", fields: [reportedCustomerId], references: [id])
  transaction      Transaction? @relation(fields: [transactionId], references: [id])

  // Bilagor (0‚Äì3 st rekommenderas i frontend)
  files ReportFile[]

  @@index([reportedCustomerId])
  @@index([transactionId])
  @@index([ratingId])
  @@index([createdAt])
}

/**
 * Bilagor som h√∂r till en Report.
 */
model ReportFile {
  id        String   @id @default(uuid())
  reportId  String
  name      String
  mimeType  String
  size      Int
  data      Bytes
  createdAt DateTime @default(now())

  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
}

/**
 * Enkel anv√§ndarmodell (admin ‚Äì ej kopplad till kundlogin just nu)
 */
model User {
  id    String @id @default(uuid())
  email String @unique
  role  String @default("admin")
}

/**
 * NYTT: Externa profiler (Blocket, senare Tradera m.fl.)
 */
model ExternalProfile {
  id           String              @id @default(uuid())
  customerId   String
  customer     Customer            @relation(fields: [customerId], references: [id])

  platform     ExternalPlatform
  username     String

  // Alternativ C: vi kan lagra ett krypterat l√∂senord + cookies
  encryptedPassword String?
  cookiesJson       Json?

  status       ExternalProfileStatus @default(ACTIVE)

  lastSyncedAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  listings     Listing[]

  @@index([customerId])
  @@index([platform, username])
}

/**
 * NYTT: Annons/snapshot fr√•n extern plattform (t.ex. Blocket-annons)
 */
model Listing {
  id                String         @id @default(uuid())
  externalProfileId String
  externalProfile   ExternalProfile @relation(fields: [externalProfileId], references: [id])

  externalListingId String         // Annons-ID p√• Blocket (om vi kan plocka ut det)
  title             String
  price             Int?
  currency          String?        @default("SEK")
  status            ListingStatus

  url               String?
  firstSeenAt       DateTime       @default(now())
  lastSeenAt        DateTime       @default(now())

  deals             Deal[]

  @@index([externalProfileId])
  @@index([externalListingId])
}

/**
 * NYTT: Aff√§rsh√§ndelse (Deal) ‚Äì underlag f√∂r omd√∂men
 */
model Deal {
  id        String     @id @default(uuid())

  listingId String?
  listing   Listing?   @relation(fields: [listingId], references: [id])

  sellerId  String
  seller    Customer   @relation("CustomerDealsAsSeller", fields: [sellerId], references: [id])

  buyerId   String?
  buyer     Customer?  @relation("CustomerDealsAsBuyer", fields: [buyerId], references: [id])

  source    DealSource @default(BLOCKET_SCRAPE)
  status    DealStatus @default(PENDING_RATING)

  blocketTitle String?
  blocketPrice Int?

  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // En deal kan ha flera ratings (k√∂pare ‚Üî s√§ljare)
  ratings Rating[]

  @@index([sellerId])
  @@index([buyerId])
  @@index([listingId])
  @@index([createdAt])
}

/**
 * Enum-typer
 */
enum ReportReason {
  FRAUD
  IMPERSONATION
  NON_DELIVERY
  COUNTERFEIT
  PAYMENT_ABUSE
  OTHER
}

enum ReportStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  REJECTED
}

// üî¥ NYTT: varifr√•n ett betyg kommer
enum RatingSource {
  BLOCKET
  TRADERA
  AIRBNB
  HUSKNUTEN_TIPTAP
  OTHER
}

// NYTT: externa plattformar (Blocket nu, fler sen)
enum ExternalPlatform {
  BLOCKET
  TRADERA
}

// NYTT: status f√∂r extern profil
enum ExternalProfileStatus {
  ACTIVE
  DISABLED
  ERROR
}

// NYTT: status f√∂r annons/listing
enum ListingStatus {
  ACTIVE      // Annonsen ligger ute
  SOLD        // Markerad som s√•ld / avslutad
  REMOVED     // F√∂rsvunnen / borttagen
}

// NYTT: status f√∂r deal
enum DealStatus {
  PENDING_RATING
  RATED
  FLAGGED
}

// NYTT: varifr√•n dealen kommer
enum DealSource {
  BLOCKET_SCRAPE
  MANUAL
  PARTNER_API
}
