generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id         String   @id @default(uuid())
  subjectRef String   @unique // Vem som betygsätts (t.ex. e-post/username)
  legalName  String?
  orgRef     String?
  country    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  ratings      Rating[]
  reports      Report[]      @relation("CustomerReports")
  score        Score?
  transactions Transaction[]
}

model Transaction {
  id          String    @id @default(uuid())
  customerId  String
  amount      Decimal?  @db.Decimal(12, 2)
  currency    String?   @default("SEK")
  occurredAt  DateTime?
  externalRef String?
  evidenceUrl String?
  ratings     Rating[]
  reports     Report[]
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model Rating {
  id            String  @id @default(uuid())
  customerId    String
  transactionId String?

  // Betyg 1–5
  score Int

  // Kommentar (från formulärets kommentarsfält)
  text String?

  // Ditt namn/e-post (från "Ditt namn/mejl")
  raterName  String?
  raterEmail String? // NYTT: Om användaren skriver in e-post

  // Verifierings-ID (t.ex. ORDER-123)
  verificationId String? // NYTT

  // Historiskt fält du hade – lämnas kvar för bakåtkomp.
  proofRef String?

  // Om kryssrutan "Rapportera misstänkt bedrägeri" var ikryssad
  reportedSuspectedFraud Boolean @default(false) // NYTT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer    Customer     @relation(fields: [customerId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  reports Report[]

  @@index([customerId])
  @@index([transactionId])
}

model Score {
  customerId String   @id
  trustScore Int
  breakdown  Json
  updatedAt  DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id])
}

model Report {
  id String @id @default(uuid())

  // Vem rapporten gäller (den som blev betygsatt)
  reportedCustomerId String

  // Kopplingar (valfria) om rapporten kommer ihop med viss transaktion/betyg
  transactionId String?
  ratingId      String?

  // Typ av problem (från "Typ av problem")
  reason ReportReason

  // Beskrivning (från "Beskrivning")
  details String?

  // Bevislänk (från "Bevislänk")
  evidenceUrl String?

  // Verifierings-ID speglat även på rapportnivå vid behov
  verificationId String? // NYTT

  status    ReportStatus @default(OPEN)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  rating           Rating?      @relation(fields: [ratingId], references: [id])
  reportedCustomer Customer     @relation("CustomerReports", fields: [reportedCustomerId], references: [id])
  transaction      Transaction? @relation(fields: [transactionId], references: [id])

  @@index([reportedCustomerId])
  @@index([transactionId])
  @@index([ratingId])
}

model User {
  id    String @id @default(uuid())
  email String @unique
  role  String @default("admin")
}

enum ReportReason {
  FRAUD
  IMPERSONATION
  NON_DELIVERY
  COUNTERFEIT
  PAYMENT_ABUSE
  OTHER
}

enum ReportStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  REJECTED
}
