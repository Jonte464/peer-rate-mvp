// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * Kunder/användare (registrera dig-formuläret)
 */
model Customer {
  id             String   @id @default(uuid())
  subjectRef     String   @unique        // används som "konto-id", vi sätter detta = email (lowercase)
  fullName       String?
  personalNumber String?  @unique
  email          String?  @unique
  phone          String?
  addressStreet  String?
  addressZip     String?
  addressCity    String?
  country        String?

  // NYTT: lösenord (hashat, aldrig klartext)
  passwordHash   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ratings      Rating[]
  reports      Report[]      @relation("CustomerReports")
  score        Score?
  transactions Transaction[]
}

/**
 * Transaktioner kopplade till kund (valfritt att koppla rating/rapport hit).
 */
model Transaction {
  id          String    @id @default(uuid())
  customerId  String
  amount      Decimal?  @db.Decimal(12, 2)
  currency    String?   @default("SEK")
  occurredAt  DateTime?
  externalRef String?
  evidenceUrl String?

  ratings     Rating[]
  reports     Report[]
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

/**
 * Enskilt betyg.
 */
model Rating {
  id            String  @id @default(uuid())
  customerId    String
  transactionId String?

  // Betyg 1–5
  score Int

  // Kommentar (från formulärets kommentarsfält)
  text String?

  // Ditt namn/e-post (från "Ditt namn/mejl")
  raterName  String?
  raterEmail String? // Om användaren skriver in e-post

  // Verifierings-ID (t.ex. ORDER-123)
  verificationId String?

  // Historiskt fält – lämnas kvar för bakåtkomp.
  proofRef String?

  // Om kryssrutan "Rapportera misstänkt bedrägeri" var ikryssad
  reportedSuspectedFraud Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer    Customer     @relation(fields: [customerId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  // En rating kan ha 0..n rapporter kopplade
  reports Report[]

  @@index([customerId])
  @@index([transactionId])
  @@index([createdAt])
}

/**
 * Sammanvägd poäng (framtida).
 */
model Score {
  customerId String   @id
  trustScore Int
  breakdown  Json
  updatedAt  DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id])
}

/**
 * Rapport om misstänkt bedrägeri/avvikelse.
 * Här lagras samtliga fält från "Rapportera misstänkt bedrägeri",
 * inkl. tidpunkt, belopp, valfri länk, samtycke och bilagor.
 */
model Report {
  id String @id @default(uuid())

  // Vem rapporten gäller (den som blev betygsatt)
  reportedCustomerId String

  // Kopplingar (valfria) om rapporten kommer ihop med viss transaktion/betyg
  transactionId String?
  ratingId      String?

  // Typ av problem (från "Typ av problem")
  reason ReportReason

  // Beskrivning (från "Beskrivning")
  details String?

  // Bevislänk (från "Bevislänk")
  evidenceUrl String?

  // Verifierings-ID (kan speglas från rating vid behov)
  verificationId String?

  // Tidpunkt då händelsen inträffade (från datetime-local)
  occurredAt DateTime?

  // Belopp + valuta (default SEK)
  amount   Decimal? @db.Decimal(12, 2)
  currency String?  @default("SEK")

  // Länk till motpart/annons/profil
  counterpartyLink String?

  // Samtycke att uppgifterna är korrekta
  reporterConsent Boolean? @default(false)

  status    ReportStatus @default(OPEN)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  rating           Rating?      @relation(fields: [ratingId], references: [id])
  reportedCustomer Customer     @relation("CustomerReports", fields: [reportedCustomerId], references: [id])
  transaction      Transaction? @relation(fields: [transactionId], references: [id])

  // Bilagor (0–3 st rekommenderas i frontend)
  files ReportFile[]

  @@index([reportedCustomerId])
  @@index([transactionId])
  @@index([ratingId])
  @@index([createdAt])
}

/**
 * Bilagor som hör till en Report.
 */
model ReportFile {
  id        String   @id @default(uuid())
  reportId  String
  name      String
  mimeType  String
  size      Int
  data      Bytes
  createdAt DateTime @default(now())

  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
}

/**
 * Enkel användarmodell (admin – ej kopplad till kundlogin just nu)
 */
model User {
  id    String @id @default(uuid())
  email String @unique
  role  String @default("admin")
}

/**
 * Enum-typer
 */
enum ReportReason {
  FRAUD
  IMPERSONATION
  NON_DELIVERY
  COUNTERFEIT
  PAYMENT_ABUSE
  OTHER
}

enum ReportStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  REJECTED
}
